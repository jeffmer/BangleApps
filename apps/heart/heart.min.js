var correlator=function(){var a=atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAt6fBHKk19RAAg1fgAgAcmqPEHAYZGb/AATAApC0ZCRti/AfGAA0/wWwkAJK8Yl/gEoO8YP3nH6woHAvEBChtKCuoCAgAqA/EBChhLuL8C8f8yCuoDA7y/YvB/AgEyACu+vwPx/zNj8H8DATO58QEJB/sHRNrRZEW8vzBGpEYBNqZFuL+mRiUuAfH/McXRCUt7RMP4hMDD+IjgKLEoI1hDTvZgI5P78PC96PCHfwAAgGr////g/v//Akt7RNP4hABwRwC/tv7//wJLe0TT+IgAcEcAv6b+//8JSXlEC2jKGBBxWhwFSxNAACu+vwPx/zNj8H8DATMLYHBHAL9/AACAlv7//w==");
return{put:E.nativeCall(357,"void(int)",a),Cmax:E.nativeCall(341,"int(void)",a),Cmin:E.nativeCall(325,"int(void)",a),bpm:E.nativeCall(141,"int(void)",a)}}(),avgMedFilter=function(){var a=atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcSnpEMLUTaALrgwEBM0hgByGT+/HxwevBAVsaibATYAGoACMRHVH4IxBA+CMQATMHK/fRaUYAIgEyUfgEXxNGBysL0Qcq99EEmwOYGEQFmwNEAyCT+/DwCbAwvVD4I0ClQsG/DWhA+CNQDGAlRgEz5ucAv9r///8=");return{filter:E.nativeCall(33,"int(int)",a)}}(),medianFilter=function(){var a=atob("BQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAACFJeUT4tQtomgAKMiLwBwIAr63rAg1KaAHrggUBMqhgkvvz8AP7ECIYSEpgbEYAInhEmkIH2gDxCAFR+CIQRPgiEAEy9ecSSnpEACHS+CTAIh9hRRPcUvgEbwExFUYIRphC9tpV+ATvdkXEvxZoLmAA8QEAxL/C+ADgdkbw51T4LAC9Rvi9AL/S////pP///4z///8=");
return{filter:E.nativeCall(41,"int(int)",a)}}(),lpfFilter=function(){var a=atob("AAAAAAAAAACBeO09gXhtPoF47T0dwDi/dfE9PhNLB+4QCntE0+0AatPtBVqT7QFq0+0GesPtAWq47sd6pe7metPtAlqn7sZ60+0DeoPtAHpm7qd65+4letPtBFrm7iV6/e7nehfukApwRwC/2v///w==");return{filter:E.nativeCall(29,"int(int)",a)}}(),hpfFilter=function(){var a=atob("AAAAAAAAAAAAzl4/AM7evwDOXj+xpNy/mO5BPxNLB+4QCntE0+0AatPtBVqT7QFq0+0GesPtAWq47sd6pe7metPtAlqn7sZ60+0DeoPtAHpm7qd65+4letPtBFrm7iV6/e7nehfukApwRwC/2v///w==");return{filter:E.nativeCall(29,
"int(int)",a)}}(),agcFilter=function(){var a=atob("AACgQcjSgz91k3g/AAAAQIDq4HIeS6Lr4HIH7hAqe0S47sd60+0AerTu53rx7hD6zL+T7QF6k+0CehZLZ+6HegfuEAp7RPjux2qT7QN6w+0Aeifuh2r07sZq8e4Q+hXcJ+5nevTux2rx7hD6DtRkI0NDB+4QOnfup3r47sdqhu6nev3ux3oX7pAKcEcAIHBH3v///7j///8=");return{filter:E.nativeCall(17,"int(int)",a)}}(),pulseDetector=function(){var a=atob("AAAAAAAAAAAUAAAA7P///xZKekQTeOuxU2iDQgHakGAe4B3d0WiTaFsaFTtA9qIxi0JP8AABjL8AIwEj0WARcAtKekRRaIhCC90AIZFgASERcAbgU2iYQgDa0GAAI+/nACMESnpEUGAYRnBH6v///7r///+Y////");
return{isBeat:E.nativeCall(17,"int(int)",a)}}();I2C1.setup({scl:D20,sda:D22,bitrate:1E5});
var HRS={writeByte:function(a,b){I2C1.writeTo(36,a,b)},readByte:function(a){I2C1.writeTo(36,a);return I2C1.readFrom(36,1)[0]},enable:function(){D14.set();setTimeout(function(){HRS.writeByte(1,8);HRS.writeByte(8,0);HRS.writeByte(10,127);HRS.writeByte(13,207);HRS.writeByte(14,6)},100)},disable:function(){HRS.writeByte(1,0);HRS.writeByte(13,0);D14.reset()},read:function(){var a=HRS.readByte(49),b=HRS.readByte(48);return a<<8|b}},x=0,lasty=175,lastPeak=0,interval,bpminterval,f1=hpfFilter.filter,f2=medianFilter.filter,
f3=agcFilter.filter,f4=lpfFilter.filter,bf=avgMedFilter.filter,det=pulseDetector.isBeat,put=correlator.put;
function doread(){var a=f4(f3(f2(f1(HRS.read()))));a=125-(a>>1);a=175<a?175:75>a?75:a;put(a);if(det(a)){var b=Date.now(),c=Math.floor(6E4/(b-lastPeak));0<c&&200>c&&(c=bf(c),g.clearRect(10,5,100,25),g.setColor(3),g.drawString("BPM: "+c,10,5,!0));lastPeak=b}g.setColor(0).fillRect(x,75,x+1,175);g.setColor(3).setPixel(x,125).setPixel(x+1,125);g.setColor(2).fillRect(x,lasty,x+1,a);g.flip();lasty=a;x+=2;176<=x&&(x=0)}
function showBPM(){var a=correlator.bpm();g.clearRect(10,35,100,60);g.setColor(1).drawString("BPM: "+a,10,35,!0);g.flip()}function startMeasure(){interval||(g.clear(),g.reset(),g.defColor(1,60),g.setFont("Vector",18),g.drawString("BPM: -- ",10,5,!0),g.flip(),x=0,HRS.enable(),setTimeout(function(){interval=setInterval(doread,40);bpminterval=setInterval(showBPM,2E3)},200))}
function stopMeasure(){interval&&(interval=clearInterval(interval),bpminterval&&(bpminterval=clearInterval(bpminterval)),HRS.disable(),g.setColor(1).drawString("PAUSED",88,20,!0).flip(),g.restoreColors())}var RUNNING=!1;DK08.on("dbltouch",function(a){RUNNING?(stopMeasure(),RUNNING=!1):(RUNNING=!0,startMeasure())});E.on("kill",function(){stopMeasure()});setTimeout(function(){E.showMessage("Double touch\n to start.\n and stop.","Heart Rate")},500);
